<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenRadio Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/unified_style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-radio"></i> KitchenRadio Control Panel</h1>
            <div class="header-controls">
                <div class="daemon-status">
                    <span id="daemon-status" class="status-indicator">
                        <i class="fas fa-circle"></i> Connecting...
                    </span>
                </div>
                <div class="source-selector">
                    <label for="source-select">
                        <i class="fas fa-toggle-on"></i> Source:
                    </label>
                    <select id="source-select" onchange="sourceChanged()">
                        <option value="">-- No Source --</option>
                        <option value="mpd">MPD Player</option>
                        <option value="spotify">Spotify</option>
                    </select>
                </div>
            </div>
        </header>

        <main>
            <!-- Unified Control Interface -->
            <section class="unified-control-panel">
                <h2>
                    <i class="fas fa-play-circle"></i> Playback Control
                    <span id="active-source-display" class="active-source">
                        No Source Selected
                    </span>
                </h2>
                
                <!-- Current Track Display -->
                <div class="current-track-display" id="current-track">
                    <div class="track-artwork">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="track-info">
                        <div class="track-title" id="track-title">No track playing</div>
                        <div class="track-artist" id="track-artist"></div>
                        <div class="track-album" id="track-album"></div>
                    </div>
                    <div class="playback-status" id="playback-status">
                        <i class="fas fa-stop"></i>
                    </div>
                </div>
                
                <!-- Playback Controls -->
                <div class="playback-controls">
                    <button id="btn-previous" onclick="sendCommand('previous')" disabled>
                        <i class="fas fa-step-backward"></i>
                        <span>Previous</span>
                    </button>
                    <button id="btn-play-pause" onclick="sendCommand('play_pause')" disabled>
                        <i class="fas fa-play"></i>
                        <span>Play</span>
                    </button>
                    <button id="btn-stop" onclick="sendCommand('stop')" disabled>
                        <i class="fas fa-stop"></i>
                        <span>Stop</span>
                    </button>
                    <button id="btn-next" onclick="sendCommand('next')" disabled>
                        <i class="fas fa-step-forward"></i>
                        <span>Next</span>
                    </button>
                </div>
                
                <!-- Volume Controls -->
                <div class="volume-controls">
                    <div class="volume-display">
                        <i class="fas fa-volume-up"></i>
                        <span id="volume-level">--</span>%
                    </div>
                    <div class="volume-buttons">
                        <button id="btn-volume-down" onclick="adjustVolume('down')" disabled>
                            <i class="fas fa-volume-down"></i>
                        </button>
                        <input type="range" id="volume-slider" min="0" max="100" value="50" 
                               onchange="setVolume(this.value)" disabled>
                        <button id="btn-volume-up" onclick="adjustVolume('up')" disabled>
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Source-Specific Panels (Collapsed by default) -->
            <details class="source-details" id="playlist-section">
                <summary>
                    <i class="fas fa-list"></i> Playlist Management
                    <span id="playlist-source-indicator" class="backend-status">
                        <i class="fas fa-circle"></i> No Source Selected
                    </span>
                </summary>
                
                <div class="backend-panel" id="playlist-panel">
                    <div class="playlist-controls">
                        <h3><i class="fas fa-list"></i> Available Playlists</h3>
                        <div class="playlist-section">
                            <select id="playlist-select">
                                <option value="">Select a playlist...</option>
                            </select>
                            <button onclick="loadPlaylist()" id="load-playlist-btn" disabled>Load Playlist</button>
                        </div>
                        <div class="playlist-info" id="playlist-info">
                            <p><i class="fas fa-info-circle"></i> Select a source to view available playlists.</p>
                        </div>
                    </div>
                </div>
            </details>
            
            <details class="source-details">
                <summary>
                    <i class="fas fa-music"></i> MPD Player Settings
                    <span id="mpd-status" class="backend-status">
                        <i class="fas fa-circle"></i> Disconnected
                    </span>
                </summary>
                
                <div class="backend-panel" id="mpd-panel">
                    <div class="mpd-info">
                        <p><i class="fas fa-info-circle"></i> MPD-specific settings and information.</p>
                    </div>
                </div>
            </details>
            
            <details class="source-details">
                <summary>
                    <i class="fab fa-spotify"></i> Spotify Settings
                    <span id="spotify-status" class="backend-status">
                        <i class="fas fa-circle"></i> Disconnected
                    </span>
                </summary>
                
                <div class="backend-panel" id="spotify-panel">
                    <div class="spotify-info">
                        <p><i class="fas fa-info-circle"></i> Spotify playback is controlled through your Spotify app. 
                        Select this source to route controls to your Spotify session.</p>
                    </div>
                </div>
            </details>
        </main>

        <!-- Status Messages -->
        <div id="status-messages" class="status-messages"></div>
    </div>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Unified Control Interface JavaScript
        let currentSource = null;
        let updateInterval = null;
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            startPeriodicUpdates();
        });
        
        // Send unified control commands
        function sendCommand(action) {
            if (!currentSource) {
                showMessage('Please select a source first', 'error');
                return;
            }
            
            fetch(`/api/control/${action}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    updateStatus(); // Refresh status immediately
                } else {
                    showMessage(data.error || 'Command failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to send command', 'error');
            });
        }
        
        // Volume control functions
        function adjustVolume(direction) {
            if (!currentSource) {
                showMessage('Please select a source first', 'error');
                return;
            }
            
            fetch(`/api/volume/${direction}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({step: 5})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateVolumeDisplay(data.volume);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'Volume control failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to adjust volume', 'error');
            });
        }
        
        function setVolume(level) {
            if (!currentSource) {
                showMessage('Please select a source first', 'error');
                return;
            }
            
            fetch(`/api/volume/${level}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateVolumeDisplay(data.volume);
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error || 'Volume control failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to set volume', 'error');
            });
        }
        
        // Source selection
        function sourceChanged() {
            const sourceSelect = document.getElementById('source-select');
            const selectedSource = sourceSelect.value;
            
            if (!selectedSource) {
                currentSource = null;
                updateControlsState(false);
                updateActiveSourceDisplay('No Source Selected');
                updatePlaylistSection(null);
                return;
            }
            
            fetch(`/api/source/${selectedSource}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSource = data.current_source;
                    updateControlsState(true);
                    updateActiveSourceDisplay(currentSource);
                    updatePlaylistSection(currentSource);
                    showMessage(data.message, 'success');
                    updateStatus(); // Refresh status immediately
                } else {
                    showMessage(data.error || 'Failed to set source', 'error');
                    sourceSelect.value = ''; // Reset selection
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to set source', 'error');
                sourceSelect.value = ''; // Reset selection
            });
        }
        
        // Update UI functions
        function updateStatus() {
            // Update daemon status and current source
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                updateDaemonStatus(data);
                updateTrackInfo(data);
                updateVolume();
            })
            .catch(error => {
                console.error('Error updating status:', error);
                updateDaemonStatus({daemon_running: false});
            });
        }
        
        function updateDaemonStatus(data) {
            const statusEl = document.getElementById('daemon-status');
            const mpdStatusEl = document.getElementById('mpd-status');
            const spotifyStatusEl = document.getElementById('spotify-status');
            
            if (data.daemon_running) {
                statusEl.innerHTML = '<i class="fas fa-circle" style="color: #4CAF50;"></i> Connected';
                statusEl.className = 'status-indicator connected';
                
                // Update backend statuses
                if (data.mpd && data.mpd.connected) {
                    mpdStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #4CAF50;"></i> Connected';
                } else {
                    mpdStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #f44336;"></i> Disconnected';
                }
                
                if (data.librespot && data.librespot.connected) {
                    spotifyStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #4CAF50;"></i> Connected';
                } else {
                    spotifyStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #f44336;"></i> Disconnected';
                }
                
                // Update current source
                if (data.current_source) {
                    currentSource = data.current_source;
                    document.getElementById('source-select').value = 
                        data.current_source === 'librespot' ? 'spotify' : data.current_source;
                    updateControlsState(true);
                    updateActiveSourceDisplay(data.current_source);
                }
                
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle" style="color: #f44336;"></i> Disconnected';
                statusEl.className = 'status-indicator disconnected';
                mpdStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #999;"></i> Unavailable';
                spotifyStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #999;"></i> Unavailable';
                updateControlsState(false);
            }
        }
        
        function updateTrackInfo(data) {
            const titleEl = document.getElementById('track-title');
            const artistEl = document.getElementById('track-artist');
            const albumEl = document.getElementById('track-album');
            const statusEl = document.getElementById('playback-status');
            const playPauseBtn = document.getElementById('btn-play-pause');
            
            let trackInfo = null;
            let state = 'stop';
            
            if (currentSource === 'mpd' && data.mpd) {
                trackInfo = data.mpd.current_song;
                state = data.mpd.state || 'stop';
            } else if (currentSource === 'librespot' && data.librespot) {
                trackInfo = data.librespot.track;
                state = data.librespot.state || 'stop';
            }
            
            if (trackInfo && (trackInfo.title || trackInfo.name)) {
                titleEl.textContent = trackInfo.title || trackInfo.name || 'Unknown Track';
                artistEl.textContent = trackInfo.artist || trackInfo.artists || '';
                albumEl.textContent = trackInfo.album || '';
            } else {
                titleEl.textContent = 'No track playing';
                artistEl.textContent = '';
                albumEl.textContent = '';
            }
            
            // Update playback status icon and play/pause button
            const isPlaying = (state === 'play') || (state === 'Playing');
            if (isPlaying) {
                statusEl.innerHTML = '<i class="fas fa-play" style="color: #4CAF50;"></i>';
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i><span>Pause</span>';
            } else if (state === 'pause' || state === 'Paused') {
                statusEl.innerHTML = '<i class="fas fa-pause" style="color: #FF9800;"></i>';
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i><span>Play</span>';
            } else {
                statusEl.innerHTML = '<i class="fas fa-stop" style="color: #999;"></i>';
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i><span>Play</span>';
            }
        }
        
        function updateVolume() {
            if (!currentSource) return;
            
            fetch('/api/volume')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.volume !== null) {
                    updateVolumeDisplay(data.volume);
                }
            })
            .catch(error => {
                console.error('Error getting volume:', error);
            });
        }
        
        function updateVolumeDisplay(volume) {
            document.getElementById('volume-level').textContent = volume;
            document.getElementById('volume-slider').value = volume;
        }
        
        function updateControlsState(enabled) {
            const buttons = ['btn-previous', 'btn-play-pause', 'btn-stop', 'btn-next', 
                           'btn-volume-down', 'btn-volume-up'];
            const slider = document.getElementById('volume-slider');
            
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = !enabled;
            });
            slider.disabled = !enabled;
        }
        
        function updateActiveSourceDisplay(source) {
            const displayEl = document.getElementById('active-source-display');
            if (source) {
                const displayName = source === 'librespot' ? 'Spotify' : source.toUpperCase();
                displayEl.textContent = displayName;
                displayEl.className = 'active-source active';
            } else {
                displayEl.textContent = 'No Source Selected';
                displayEl.className = 'active-source inactive';
            }
        }
        
        function startPeriodicUpdates() {
            // Update status every 2 seconds
            updateInterval = setInterval(updateStatus, 2000);
        }
        
        function showMessage(message, type = 'info') {
            const messagesContainer = document.getElementById('status-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `status-message ${type}`;
            messageEl.textContent = message;
            
            messagesContainer.appendChild(messageEl);
            
            // Auto-remove message after 3 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }
        
        // Generic playlist functions
        function updatePlaylistSection(source) {
            const playlistIndicator = document.getElementById('playlist-source-indicator');
            const playlistInfo = document.getElementById('playlist-info');
            const playlistSelect = document.getElementById('playlist-select');
            const loadButton = document.getElementById('load-playlist-btn');
            
            if (!source) {
                playlistIndicator.innerHTML = '<i class="fas fa-circle" style="color: #999;"></i> No Source Selected';
                playlistInfo.innerHTML = '<p><i class="fas fa-info-circle"></i> Select a source to view available playlists.</p>';
                playlistSelect.innerHTML = '<option value="">Select a playlist...</option>';
                loadButton.disabled = true;
                return;
            }
            
            const displayName = source === 'librespot' ? 'Spotify' : source.toUpperCase();
            playlistIndicator.innerHTML = `<i class="fas fa-circle" style="color: #4CAF50;"></i> ${displayName}`;
            loadButton.disabled = false;
            
            // Load playlists for the current source
            loadPlaylists();
        }
        
        function loadPlaylists() {
            if (!currentSource) return;
            
            fetch('/api/playlists')
            .then(response => response.json())
            .then(data => {
                const playlistSelect = document.getElementById('playlist-select');
                const playlistInfo = document.getElementById('playlist-info');
                
                // Clear existing options
                playlistSelect.innerHTML = '<option value="">Select a playlist...</option>';
                
                if (data.success) {
                    if (data.playlists && data.playlists.length > 0) {
                        data.playlists.forEach(playlist => {
                            const option = document.createElement('option');
                            option.value = playlist;
                            option.textContent = playlist;
                            playlistSelect.appendChild(option);
                        });
                        playlistInfo.innerHTML = `<p><i class="fas fa-music"></i> Found ${data.playlists.length} playlist(s) for ${data.source.toUpperCase()}.</p>`;
                    } else {
                        if (data.source === 'spotify') {
                            playlistInfo.innerHTML = '<p><i class="fab fa-spotify"></i> Spotify playlists are managed through your Spotify app. Use your Spotify client to select and play playlists.</p>';
                        } else {
                            playlistInfo.innerHTML = '<p><i class="fas fa-info-circle"></i> No playlists found for this source.</p>';
                        }
                    }
                } else {
                    playlistInfo.innerHTML = `<p><i class="fas fa-exclamation-triangle"></i> Error loading playlists: ${data.error}</p>`;
                }
            })
            .catch(error => {
                console.error('Error loading playlists:', error);
                const playlistInfo = document.getElementById('playlist-info');
                playlistInfo.innerHTML = '<p><i class="fas fa-exclamation-triangle"></i> Failed to load playlists.</p>';
            });
        }
        
        function loadPlaylist() {
            const select = document.getElementById('playlist-select');
            const playlist = select.value;
            
            if (!playlist) {
                showMessage('Please select a playlist', 'error');
                return;
            }
            
            if (!currentSource) {
                showMessage('No active source selected', 'error');
                return;
            }
            
            fetch('/api/load_playlist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({playlist: playlist})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    updateStatus(); // Refresh status to show new track
                } else {
                    showMessage(data.error || 'Failed to load playlist', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to load playlist', 'error');
            });
        }
        
        // Legacy MPD playlist functions (for backward compatibility)
        function loadMPDPlaylist() {
            const select = document.getElementById('mpd-playlist-select');
            const playlist = select.value;
            if (!playlist) {
                showMessage('Please select a playlist', 'error');
                return;
            }
            
            fetch('/api/mpd/load_playlist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({playlist: playlist})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`Loaded playlist: ${playlist}`, 'success');
                } else {
                    showMessage(data.error || 'Failed to load playlist', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to load playlist', 'error');
            });
        }
    </script>
</body>
</html>
